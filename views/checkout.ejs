<!DOCTYPE html>
<html lang="en">
<head>
    <%- include('partials/head'); %>
    <link rel="stylesheet" href="css/addcart.css">
</head>
<body class="body">
    <%- include('partials/navbar'); %>

    <!-- Add to Cart -->
    <div class="card">
        <div class="row">
            <div class="title">
                <div class="row">
                    <div class="col">
                        <h4 class="text-center"><b>Panier</b></h4>
                    </div>
                    <div class="col align-self-center text-right text-muted"></div>
                </div>
            </div>

            <div class="col-md-8 cart outerContainer">
            <!-- List products from cart here -->
                
            </div>
            <div class="col-md-4 summary">
                <div>
                    <h5><b>Paiement</b></h5>
                </div>
                <hr>
                <!-- <div class="row">
                    <div class="col" style="padding-left:0;">ITEMS 3</div>
                </div> -->
                <form>
                    <p>Options</p>
                    <select>
                        <option class="text-muted">Options de paiement</option>
                        <option class="text-muted">Payer cash sur livraison</option>
                        <option class="text-muted">Payer avec JUICE sur livraison</option>
                    </select>
                </form>
                <div class="row" style="border-top: 1px solid rgba(0,0,0,.1); padding: 2vh 0;">
                    <div class="col">Prix Total</div>
                    <div class="col text-right cart-total">0</div>
                </div> 
            </div>
            <div class="customer_form">
                <div>
                    <h2 class="title orange">Remplissez le formulaire ci-dessous</h2>
                </div>
                <form>
                    <div class="form-group form_spacing">
                        <label for="first_name_customer">Prénom:</label>
                        <input type="text" class="form-control" name="first_name_customer" id="first_name_customer" placeholder="Prénom" required>
                    </div>
                    <div class="form-group form_spacing">
                        <label for="last_name_customer">Nom de famille:</label>
                        <input type="text" class="form-control" name="last_name_customer" id="last_name_customer" placeholder="Nom de famille" required>
                    </div>
                    <div class="form-group form_spacing">
                        <label for="email_customer">E-mail:</label>
                        <input type="text" class="form-control" name="email_customer" id="email_customer" placeholder="E-mail" required>
                    </div>
                    <div class="form-group form_spacing">
                        <label for="phone_customer">Numéro de téléphone:</label>
                        <input type="number" class="form-control" name="phone_customer" id="phone_customer" placeholder="Numéro de téléphone" required>
                    </div>
                    <div class="form-group form_spacing">
                        <label for="address_customer">Adresse:</label>
                        <input type="text" class="form-control" name="address_customer" id="address_customer" placeholder="Adresse" required>
                    </div>
                    <div class="btn-customer">
                        <button type="submit" onclick="add_customer()" style="width: 115px;">Confim</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    
 
    <script>
        //DummyDatabase
        let cartMenu = [
            {
                product_id: "1",
                category: "Meal",
                price: 100,
                product_name_fr: "Poulet",
                qty: 2,
            },
            {
                product_id: "2",
                category: "Meal",
                price: 200,
                product_name_fr: "Briyani",
                qty: 2,
            },
            {
                product_id: "3",
                category: "Snack",
                price: 50,
                product_name_fr: "Gateau Piment",
                qty: 2,
            },
            {
                product_id: "4",
                category: "Snack",
                price: 30,
                product_name_fr: "Boulettes",
                qty: 2,
            },
        ]

        // <div class="row border-top border-bottom innerContainer">
        //     <div class="row main align-items-center">
        //         <div class="col-2">
        //            <img class="img-fluid" src="https://i.imgur.com/1GrakTl.jpg">
        //         </div>
        //         <div class="col">
        //             <div class="row text-muted test_name"></div>
        //             <div class="row test_product"> </div>
        //         </div>
        //         <div class="col ">
        //             <input type="number" value="1" class="quantity" onchange="updateTotal()">
        //         </div>
        //         <div class="col cart-price">
        //             <span class="close"><i class="fa fa-trash" aria-hidden="true"></i></span>
        //         </div>

        //     </div>
        // </div>

        function display_products(){
            let cartItemContainer = document.getElementsByClassName('outerContainer')[0];

            let products = JSON.parse(sessionStorage.getItem("cart"));
            
            // ToDo check if products are not null or undefined
            for (item of products){
                item = JSON.parse(item);

                let innerContainer = document.createElement('div');
                innerContainer.className = "row border-top border-bottom innerContainer";

                let row = document.createElement('div');
                row.className = "row main align-items-center";

                let img_div = document.createElement('div');
                img_div.className = "col-2"
                let img = document.createElement('img');
                //img.src = item.picture;
                img.src="https://i.imgur.com/1GrakTl.jpg";
                img_div.append(img);

                let product_div = document.createElement('div');
                product_div.className = "col";

                let product_name = document.createElement('div');
                product_name.className = "row";
                
                product_name.innerText = item.product_name_fr;
                let product_id = document.createElement('div');
                product_id.className = "row text-muted product-serial";
                product_id.innerText = create_product_serial(item.product_id);
                product_div.appendChild(product_name);
                product_div.appendChild(product_id);

                let qty_div = document.createElement('div');
                qty_div.className = "col";
                qty_div.innerHTML = `<input type="number" value=${item.qty} class="quantity" onchange="update_cart();">`;

                let price_div = document.createElement('div');
                price_div.className = "col cart-price";
                price_div.innerHTML = `Rs ${parseInt(item.price)}&nbsp;&nbsp;&nbsp;<span class="close" style=""><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-trash" viewBox="0 0 16 16"><path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/><path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/></svg></span>`

                // row.append(img_div);
                row.appendChild(product_div);
                row.appendChild(qty_div);
                row.appendChild(price_div);

                innerContainer.append(row);
                cartItemContainer.append(innerContainer);
            }

            let removeCartItemButtons = document.getElementsByClassName('close')
            for(let i =0; i< removeCartItemButtons.length; i++){
            let button = removeCartItemButtons[i];
            button.addEventListener('click', function(event){
                let buttonClicker = event.target;
                buttonClicker.parentElement.parentElement.parentElement.parentElement.remove();
                update_cart();
            })
            }
        }

        function updateTotal(){
            let total = 0;
            let cartItemContainer = document.getElementsByClassName('outerContainer')[0]
            let cartRows = cartItemContainer.getElementsByClassName('innerContainer')
            for (let i = 0; i < cartRows.length; i++){
                let cartRow = cartRows[i]
                let priceElement = cartRow.getElementsByClassName('cart-price')[0];
                let quantityElement = cartRow.getElementsByClassName('quantity')[0];
                let price = parseFloat(priceElement.innerText.replace('Rs', ''));
                let quantity = parseFloat(quantityElement.value);
                total = total + (price * quantity);
            }
            document.getElementsByClassName('cart-total')[0].innerHTML = 'Rs ' + total.toLocaleString();
        }

        function update_cart(){
            let product_serials = document.getElementsByClassName('product-serial');
            let product_qty = document.getElementsByClassName('quantity');

            let cart = sessionStorage.getItem("cart");
            cart = JSON.parse(cart);

            for (i in product_serials){
                if (product_serials[i].innerText != undefined){
                    let product_id = convert_product_id_serial(product_serials[i].innerText);

                    for (k in cart){
                        item = JSON.parse(cart[k]);
                        if (item.product_id == product_id){
                            item.qty = product_qty[i].value;
                            cart[k] = JSON.stringify(item);
                            console.log(cart);
                            break;
                        }
                    }
                }
            }
            console.log(cart);
            sessionStorage.setItem("cart", JSON.stringify(cart));
            updateTotal();
        }

        function create_product_serial(product_id){
            return ("N" + product_id.toString().padStart(4, 0));
        }

        function convert_product_id_serial(product_serial){
            console.log(product_serial);
            return Number(product_serial.slice(1));
        }

        display_products();
        updateTotal();
    </script>


    <%- include('partials/footer.ejs'); %>
    
    <script src="js/checkout.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js" integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p" crossorigin="anonymous"></script>
</body>
</html>


